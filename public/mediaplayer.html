<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>S0LACE • Media Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <!-- Only need SW + global stuff here -->
    <script src="register-sw.js" defer></script>
    <script src="global-hub.js" defer></script>
  </head>

  <body>
    <header class="site-header">
      <div class="site-title">
        S0LACE
      </div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="media.html" class="active">Media</a>
        <a href="apps.html">Apps</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main class="player-main">
      <div class="player-info">
        <div class="player-left">
          NOW PLAYING: <span id="player-title">loading…</span>
        </div>
        <div class="player-actions">
          <a
            id="open-direct"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            style="display:none"
          >
            open raw
          </a>
          <button id="reload-btn" type="button" style="display:none">
            reload
          </button>
          <a href="media.html">back to media</a>
        </div>
      </div>

      <div class="player-frame-wrap" id="frame-wrap">
        <!-- iframe gets injected here -->
      </div>

      <div class="no-src" id="no-src" style="display:none;">
        no media loaded. go back to the media page and pick something.
      </div>
    </main>

    <script>
      function getParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      async function bootPlayer() {
        const rawSrc = getParam("src");
        const title = getParam("title") || "Media";

        const titleEl = document.getElementById("player-title");
        const openDirect = document.getElementById("open-direct");
        const reloadBtn = document.getElementById("reload-btn");
        const wrap = document.getElementById("frame-wrap");
        const noSrc = document.getElementById("no-src");

        if (titleEl) titleEl.textContent = title;

        if (!rawSrc) {
          if (wrap) wrap.style.display = "none";
          if (noSrc) noSrc.style.display = "flex";
          if (openDirect) openDirect.style.display = "none";
          if (reloadBtn) reloadBtn.style.display = "none";
          return;
        }

        let src = decodeURIComponent(rawSrc).trim();

        // src is allowed to be:
        //   - /scramjet/https://...
        //   - /scram/https://...
        //   - https://...
        // We DO NOT touch it for the iframe – we just feed it straight in.
        if (!src.startsWith("/scramjet/") &&
            !src.startsWith("/scram/") &&
            !/^https?:\/\//i.test(src)) {
          console.error("mediaplayer: invalid src", src);
          if (wrap) wrap.style.display = "none";
          if (noSrc) {
            noSrc.style.display = "flex";
            noSrc.textContent = "invalid media URL.";
          }
          if (openDirect) openDirect.style.display = "none";
          if (reloadBtn) reloadBtn.style.display = "none";
          return;
        }

        // Try to extract a raw URL for the "open raw" button if we can
        let rawUrl = null;
        if (src.startsWith("/scramjet/")) {
          rawUrl = src.slice("/scramjet/".length);
        } else if (src.startsWith("/scram/")) {
          rawUrl = src.slice("/scram/".length);
        } else if (/^https?:\/\//i.test(src)) {
          rawUrl = src;
        }

        if (rawUrl && /^https?:\/\//i.test(rawUrl)) {
          openDirect.href = rawUrl;
          openDirect.style.display = "inline-flex";
        } else {
          openDirect.style.display = "none";
        }

        if (reloadBtn) reloadBtn.style.display = "inline-flex";

        // Make sure SW is registered before the iframe hits /scramjet/...
        try {
          if (typeof registerSW === "function") {
            await registerSW();
          }
        } catch (err) {
          console.warn("SW registration failed in mediaplayer:", err);
          // still try to load iframe anyway
        }

        if (!wrap) {
          console.error("no frame wrapper");
          return;
        }

        // clear any old frame
        wrap.innerHTML = "";

        const iframe = document.createElement("iframe");
        iframe.id = "media-frame";
        iframe.src = src;
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "none";

        wrap.appendChild(iframe);

        if (reloadBtn) {
          reloadBtn.onclick = () => {
            iframe.src = src;
          };
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        bootPlayer().catch((err) =>
          console.error("mediaplayer boot error:", err)
        );
      });
    </script>
  </body>
</html>
