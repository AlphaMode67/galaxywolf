<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S0LACE • Settings</title>

  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="stylesheet" href="index.css" />

  <!-- Settings Engine -->
  <script src="global-hub.js" defer></script>
  <script src="register-sw.js" defer></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
<header class="site-header">
  <div class="site-title">S0LACE</div>
  <nav class="site-nav">
    <a href="index.html">Home</a>
    <a href="games.html">Games</a>
    <a href="media.html">Media</a>
    <a href="settings.html" class="active">Settings</a>
    <a href="account.html" class="account-link">
      <img id="account-icon" alt="Account" />
    </a>
  </nav>
</header>

<main>
  <div class="page-header"><h1>Settings</h1></div>

  <!-- GRID LAYOUT (3 columns) -->
  <div class="settings-grid">

    <!-- ========= TAB CLOAKING ========= -->
    <section class="home-panel">
      <div class="motd-label">TAB CLOAKING</div>

      <label class="settings-label">Preset</label>
      <select id="cloak-select" class="settings-select">
        <option value="">Select Preset…</option>
        <option value="drive">Google Drive</option>
        <option value="schoology">Schoology</option>
        <option value="docs">Google Docs</option>
        <option value="google">Google</option>
        <option value="custom">Custom…</option>
      </select>

      <div id="custom-cloak-box" style="display:none; margin-top:10px;">
        <label class="settings-label">Title</label>
        <input id="cloak-title" class="settings-input" placeholder="My Drive - Google Drive">

        <label class="settings-label">Favicon URL</label>
        <input id="cloak-icon" class="settings-input" placeholder="https://.../favicon.ico">

        <button id="apply-custom-cloak" class="proxy-btn" style="margin-top:8px;">Apply</button>
      </div>

      <div id="cloak-status" class="settings-status"></div>
    </section>

    <!-- ========= THEME + ACCENT ========= -->
    <section class="home-panel">
      <div class="motd-label">THEME + ACCENT</div>

      <label class="settings-label">Theme</label>
      <select id="theme-select" class="settings-select">
        <option value="dark">Dark</option>
        <option value="baby">Blue</option>
        <option value="xmas">Green (Xmas)</option>
      </select>

      <label class="settings-label" style="margin-top:12px;">Accent Color</label>
      <select id="accent-select" class="settings-select">
        <option value="green">Green</option>
        <option value="violet">Violet</option>
        <option value="amber">Amber</option>
        <option value="white">White</option>
      </select>
    </section>

    <!-- ========= BACKGROUND ========= -->
    <section class="home-panel">
      <div class="motd-label">BACKGROUND</div>

      <label class="settings-label">Mode</label>
      <select id="bg-mode" class="settings-select">
        <option value="default">Default (CRT Grid)</option>
        <option value="gif-stars">Starry GIF</option>
        <option value="custom">Custom Image</option>
      </select>

      <div id="bg-url-row" style="display:none; margin-top:10px;">
        <label class="settings-label">Image URL</label>
        <input id="bg-url" class="settings-input" placeholder="https://example/bg.gif">
      </div>
    </section>

    <!-- ========= SECURITY ========= -->
    <section class="home-panel">
      <div class="motd-label">SECURITY</div>

      <label class="settings-label">
        <input type="checkbox" id="anti-close-toggle">
        Anti-Close Protection
      </label>

      <button id="blank-launch" class="proxy-btn" style="margin-top:12px;">
        Launch in about:blank
      </button>
    </section>

    <!-- ========= ABOUT / DMCA ========= -->
    <section class="home-panel">
      <div class="motd-label">INFO</div>

      <a href="about.html" class="settings-link">About S0LACE</a>
      <a href="dmca.html" class="settings-link">DMCA Request</a>
    </section>

    <!-- ========= STORAGE ========= -->
    <section class="home-panel">
      <div class="motd-label">STORAGE</div>

      <button id="btn-reset-settings" class="proxy-btn">Reset Settings</button>
      <button id="btn-clear-media" class="proxy-btn" style="margin-top:8px;">Clear Media Cache</button>

      <p class="settings-status" style="margin-top:10px;">
        Stored in <span style="color:var(--accent);">localStorage</span>.
      </p>
    </section>

  </div> <!-- /grid -->
</main>

<script>
/* ============================================================
   SETTINGS LOGIC — FIXED & CLEANED
============================================================ */

/* ----- Tab Cloaking ----- */
const cloakSelect = document.getElementById("cloak-select");
const customBox   = document.getElementById("custom-cloak-box");
const titleInput  = document.getElementById("cloak-title");
const iconInput   = document.getElementById("cloak-icon");
const applyBtn    = document.getElementById("apply-custom-cloak");
const statusEl    = document.getElementById("cloak-status");

const PRESETS = {
  drive: {
    title: "My Drive - Google Drive",
    iconHref: "https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png"
  },
  schoology: {
    title: "Schoology",
    iconHref: "https://asset-cdn.schoology.com/sites/all/themes/schoology_theme/favicon.ico"
  },
  docs: {
    title: "Document - Google Docs",
    iconHref: "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico"
  },
  google: {
    title: "Google",
    iconHref: "favicon.ico"
  }
};

// Preset selection logic (FIXED)
cloakSelect.addEventListener("change", () => {
  const val = cloakSelect.value;

  customBox.style.display = val === "custom" ? "block" : "none";

  if (!PRESETS[val]) return;

  const preset = PRESETS[val];
  window.S0LACE.applyTabCloak(preset, true);

  // Force real favicon + title update
  document.title = preset.title;
  setTimeout(() => {
    const link = document.querySelector("link[rel='icon']");
    if (link) link.href = preset.iconHref;
  }, 30);

  statusEl.textContent = "Preset applied.";
});

applyBtn.addEventListener("click", () => {
  const cfg = {
    enabled: true,
    title: titleInput.value.trim(),
    iconHref: iconInput.value.trim()
  };

  if (!cfg.title) return statusEl.textContent = "Title required.";

  window.S0LACE.applyTabCloak(cfg, true);
  statusEl.textContent = "Custom cloak applied.";
});

/* ----- THEME + ACCENT ----- */
document.getElementById("theme-select").addEventListener("change", e => {
  window.S0LACE.applyTheme(e.target.value, true);
});

document.getElementById("accent-select").addEventListener("change", e => {
  window.S0LACE.applyAccent(e.target.value, true);
});

/* ----- BACKGROUND ----- */
const bgMode = document.getElementById("bg-mode");
const bgUrlRow = document.getElementById("bg-url-row");
const bgUrl = document.getElementById("bg-url");

bgMode.addEventListener("change", () => {
  const mode = bgMode.value;
  bgUrlRow.style.display = mode === "custom" ? "block" : "none";

  window.S0LACE.applyBackground(mode, bgUrl.value.trim(), true);
});

bgUrl.addEventListener("blur", () => {
  if (bgMode.value === "custom") {
    window.S0LACE.applyBackground("custom", bgUrl.value.trim(), true);
  }
});

/* ----- SECURITY ----- */
const antiClose = document.getElementById("anti-close-toggle");
antiClose.checked = localStorage.getItem("s0laceAntiClose") === "1";

antiClose.addEventListener("change", () => {
  if (antiClose.checked) window.S0LACE.enableAntiClose();
  else window.S0LACE.disableAntiClose();
});

// Launch in about:blank
document.getElementById("blank-launch").addEventListener("click", () => {
  const win = window.open("about:blank", "_blank");
  if (!win) return alert("Enable popups first.");
  win.document.write(`
    <style>
      body { margin:0; background:black; display:flex; align-items:center; justify-content:center; }
      iframe { width:100vw; height:100vh; border:none; }
    </style>
    <iframe src="${location.origin}/index.html"></iframe>
  `);
});

/* ----- STORAGE ----- */
document.getElementById("btn-reset-settings").addEventListener("click", () => {
  if (!confirm("Reset ALL S0LACE settings?")) return;
  localStorage.clear();
  location.reload();
});

document.getElementById("btn-clear-media").addEventListener("click", () => {
  localStorage.removeItem("s0laceMediaCache");
  alert("Media cache cleared.");
});
</script>

</body>
</html>
